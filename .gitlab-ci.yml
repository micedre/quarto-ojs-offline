# GitLab CI/CD configuration for publishing Quarto to GitLab Pages
# This pipeline builds the Quarto project and publishes it to GitLab Pages

stages:
  - build
  - deploy


# Build stage - compile the Quarto project
build:
  stage: build
  image: proxy-ghcr-io.insee.fr/astral-sh/uv:latest
  script:
    - echo "Installing Python dependencies for OJS offline extension using uv..."
    - uv pip install requests  # Required for some download operations
    
    - echo "Running OJS offline setup to download libraries..."
    - cd _extensions/ojs-offline && uv run python setup.py
    - cd ../../
    
    - echo "Building Quarto project..."
    - uv run --with quarto quarto render --to html --output-dir public
    
    - echo "Build completed successfully!"
  artifacts:
    paths:
      - public/
    expire_in: 1 week
  only:
    - main

# Deploy stage - publish to GitLab Pages
pages:
  stage: deploy
  script:
    - echo "Deploying to GitLab Pages..."
  artifacts:
    paths:
      - public
  only:
    - main
  dependencies:
    - build

# Optional: Add a test job to verify the build
# test:
#   stage: test
#   image: ${QUARTO_IMAGE}
#   script:
#     - echo "Running tests..."
#     # Add your test commands here
#   only:
#     - main